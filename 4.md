# 三连击：长连接、微信支付、OTA升级
为什么长连接、微信支付、OTA升级是三连击？

“长连接”之前售货机和服务器之间的通讯协议是售货机主动定时轮询服务器，而长连接让服务器和售货机始终保持着通讯通道。

“长连接”让微信支付购买售货机内商品成为了可能 -- 用户支付成功后，微信支付通知友宝服务器，友宝服务器要能立即通知指定售货机出货某件商品。

“微信支付”的强烈需求促进了OTA升级的必要性。

因此“长连接 - 微信支付 - OTA升级”构成了环环相扣的三连击，这三连击也让友宝售货机成为真正的互联网售货机。

## 长链接：相信3G网络
从原来售货机发起HTTP轮询的通讯协议，到基于TCP长连接的通讯协议，技术选型的核心依据是什么？是对3G网络的信心。

2012年底，中国3G用户才2.2亿，而且多数是不太靠谱的TD-SCDMA。对3G网络的覆盖率、可靠性、大规模之下的速率等关键指标的信心，是技术选型的基础。显然我们选择了相信中国3G网络。

而在协议切换和升级过程中，最初连续2、3天的不安煎熬记忆犹新，过程中产品和研发骨干的坚定更让我一直铭记。

## 微信支付：相信移动互联网
2013年8月5日微信支付随微信5.0发布，而在发布前一个多月的一个会上，偶然了解到微信支付将要发布的消息。果断陌生邮件发给lake/曾鸣，讲述了让微信支付可以购买售货机商品的设想，立刻得到了lake的回应。于是立刻飞到广州，确定合作，开始技术对接。技术上两周多完成对接，于是友宝自动售货机在微信支付发布的day 0便支持了这个历史性的支付方式。

再往后，和wawa、momo、teddy等一众微信支付伙伴，一起策划十一的一分购、元旦的一元购等等，一起解决支付体验问题、银行卡支持数量有限问题。。。开始了一段终生难忘的旅程。

微信支付是史诗级的产品，而友宝有幸一直冲在排头，在所有行业里最先实现全网点支持、最快实现微信支付占比提升、最快实现“无现金”。帮助微信支付和支付宝塑造了无人零售行业的购买体验。

## OTA升级：运维的基础长链接
2013年Q3，微信支付的热度带来了售货机端软件更快速迭代和实施到所有网点的需求，这个需求促使我们把OTA在线升级的基础设施建设提到了很高的优先级。

从最初的手动远程升级到后面的自动远程升级、系统化远程升级，“OTA”升级和自动运行状态监控、告警一起构成了友宝售货机维护的基础设施。

在“长连接 - 微信支付 - OTA升级”的三连击之后，友宝的售货机可以随时接受云端指令受其“摆布”了、友宝售货机和移动互联网最大的APP微信/支付宝实现打通、友宝售货机可以像手机APP一样自动升级，成为了真正的“互联网售货机”。
